<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>foodaccess</title>
    <meta charset="UTF-8">
    <link rel="icon" href="images/icon_webtab.png" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="JS_CSS_downloaded_libraries/dc.css">
    <link rel="stylesheet" type="text/css" href="JS_CSS_downloaded_libraries/leaflet.css">
    <!-- <link rel="stylesheet" type="text/css" href="JS_CSS_downloaded_libraries/bootstrap.css"> -->
    <link rel="stylesheet" type="text/css" href="JS_CSS_downloaded_libraries/leaflet.markerCluster.css">

    <!-- <link rel="stylesheet" type="text/css" href="JS_CSS_downloaded_libraries/leaflet-legend.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="JS_CSS_downloaded_libraries/jquery.dataTables.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="JS_CSS_downloaded_libraries/leaflet-control-minimap.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="JS_CSS_downloaded_libraries/google_font_Esteban.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="JS_CSS_downloaded_libraries/L.Control.BetterScale.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="myCSS_styleFiles/main.css"> -->
    <style>
        #holder {
            width: 850px;
            margin: 20px auto;
        }
        
        #holder>div {
            padding: 30px 0;
            clear: both;
        }
        
        .map {
            width: 600px;
            height: 400px;
        }
        
        .pie {
            margin-left: 30px;
        }
        
        #octocat {
            position: absolute;
            right: 5px;
            top: 5px;
        }
        /*map legend styling*/
        /*--*/
    </style>
</head>


<body data-spy="scroll" data-target=".navbar" data-offset="100">

    <!-- <div class="container-fluid">
        <div class="row-title" id="control-row">
            <div class="col-xs-12 dc-data-count dc-chart" id="data-count">

              <h3 id="main-title" style="font-family: 'Esteban';"><b><i>ABQ Food</i></b></h3>
                <div id="loadingGIF"></div>

                <div class="row" id="count-row">
                    <div class="col-xs-12 dc-dataTitle-count dc-chart" id="data-count">
                        <h4>Reviewed Papers
                            <small>
            <span class="filter-count"></span> selected out of <span class="total-count"></span> records |
            <a id="all" href="javascript:location.reload();">Reset All</a><i style="color: black;"> (all legends of the donut charts are scrollable and filterable)</i>
            </span>
            </small>

                        </h4>
                    </div>
                </div>
            </div>
        </div>

        <div id="section1" class="container-fluid">
            <div class="row" id="control-row-map">
                <div class="col-xs-12 col-md-7">
                    <div class="map" id='map'></div>
                    <div id='cluster-map-anchor'></div>
                </div>
                <div class="col-md-2 pie-chart">
                    <h4><br>county <small><a id="county">reset</a></small></h4>
                    <div class="dc-chart" id="chart-ring-county"></div>
                    <div style="width:150px; height:120px" id="county-legend" class="dc-html-legend-container"></div>
                </div>

            </div>
        </div>

        <div id="section2" class="container-fluid">
            <div class="row" id="control-row">
                <div class="col-xs-12">
                    <div>
                        <div class="dc-dataTable-count">
                            <b><span class="filter-count"></span> selected out of <span class="total-count"></span> records</b>
                        </div>
                    </div>
                    <table id="data-table" class="table table-hover dc-data-table">
                    </table>
                </div>
                <div class="row" id="control-row">
                    <div class="col-xs-12">
                        <table id="data-table" class="table table-hover dc-data-table">
                        </table>
                    </div>
                </div>
            </div>
        </div> 
    </div>-->
    <div id="holder">
        <div id="demo1">
            <h2>Markers with clustering, popups and single selection</h2>
            <i>Renewable energy plants in Bulgaria in 2012</i>
            <div class="map" id='cluster-map'></div>
            <div id='cluster-map-anchor'></div>
            <div class="pie"></div>
        </div>

        <div id="demo2">
            <h2>Markers with no clustering and selection by area</h2>
            <i>Renewable energy plants in Bulgaria in 2012</i>
            <div class="map"></div>
            <div class="pie"></div>
        </div>

        <div id="demo3">
            <h2>Le choropleth</h2>
            <i>Population by age groups in Bulgaria in 2011 (excluding the capital)</i>
            <div class="map"></div>
            <div class="pie"></div>
        </div>

        <div id="demo4">
            <h2>Bubble chart</h2>
            <i>Population by age groups in Bulgaria in 2011</i>
            <div class="map"></div>
            <div class="pie"></div>
        </div>
    </div>
    <script type="text/javascript" src="JS_CSS_downloaded_libraries/d3v5.16.0.js"></script>
    <script type="text/javascript" src="JS_CSS_downloaded_libraries/crossfilterv1.5.4.js"></script>
    <script type="text/javascript" src="JS_CSS_downloaded_libraries/dc4.2.0.js"></script>
    <script type="text/javascript" src="JS_CSS_downloaded_libraries/Leafletv1.6.0.js"></script>
    <!-- <script type="text/javascript" src="JS_CSS_downloaded_libraries/colorbrewer.js"></script> -->
    <!-- <script type="text/javascript" src="JS_CSS_downloaded_libraries/underscore-min.js"></script> -->
    <!-- <script type="text/javascript" src="JS_CSS_downloaded_libraries/jQuery.js"></script> -->
    <!-- <script type="text/javascript" src="JS_CSS_downloaded_libraries/Bootstrap.js"></script> -->
    <script type="text/javascript" src="JS_CSS_downloaded_libraries/leaflet.markerCluster.js"></script>
    <script type="text/javascript" src="JS_CSS_downloaded_libraries/dc.leafletv0.5.5.js"></script>
    <script type="text/javascript" src="JS_CSS_downloaded_libraries/colorbrewer.js"></script>
    <!-- <script type="text/javascript" src="JS_CSS_downloaded_libraries/dc.leaflet.js"></script> -->
    <!-- <script type="text/javascript" src="JS_CSS_downloaded_libraries/jquery.dataTables.js"></script>
    <script type="text/javascript" src="JS_CSS_downloaded_libraries/dc.datatables.js"></script>
    <script type="text/javascript" src="JS_CSS_downloaded_libraries/leaflet-osm.js"></script>
    <script type="text/javascript" src="JS_CSS_downloaded_libraries/Control.MiniMap.js"></script>
    <script type="text/javascript" src="JS_CSS_downloaded_libraries/L.Control.BetterScale.js"></script> -->
    <!-- <script type="text/javascript" src="data/NewMexico10.js"></script> -->
    <script>
        var clusterMap = L.map('cluster-map', {
            center: [42.69, 25.42],
            zoom: 7
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(clusterMap);

        var facilitiesGroup = false;
        var returnObject = false;

        /*     Markers      */

        d3.tsv("demo1.tsv").then(function(data) {
            drawMarkerSelect(data);
            drawMarkerArea(data);
        });

        function drawMarkerSelect(data) {
            var xf = crossfilter(data);
            var groupname = "marker-select";
            var facilities = xf.dimension(function(d) {
                return d.geo;
            });
            var facilitiesGroup = facilities.group().reduceCount();

            var marker = dc_leaflet.markerChart("#cluster-map-anchor", groupname)
                .dimension(facilities)
                .group(facilitiesGroup)
                .map(clusterMap)
                .showMarkerTitle(false)
                .fitOnRender(true)
                .fitOnRedraw(true)
                .filterByArea(true)
                .cluster(true);


            var types = xf.dimension(function(d) {
                return d.type;
            });
            var typesGroup = types.group().reduceCount();

            var pie = dc.pieChart("#demo1 .pie", groupname)
                .dimension(types)
                .group(typesGroup)
                .width(200)
                .height(200)
                .renderLabel(true)
                .renderTitle(true)
                .ordering(function(p) {
                    return -p.value;
                });

            dc.renderAll(groupname);
            return {
                marker: marker,
                pie: pie
            };
        }

        function drawMarkerArea(data) {
            var xf = crossfilter(data);
            var groupname = "marker-area";
            var facilities = xf.dimension(function(d) {
                return d.geo;
            });
            var facilitiesGroup = facilities.group().reduce(
                function(p, v) {
                    p.type = v.type;
                    ++p.count;
                    return p;
                },
                function(p, v) {
                    --p.count;
                    return p;
                },
                function() {
                    return {
                        count: 0
                    };
                }
            );

            var marker = dc_leaflet.markerChart("#demo2 .map", groupname)
                .dimension(facilities)
                .group(facilitiesGroup)
                .valueAccessor(d => d.value.count)
                .width(600)
                .height(400)
                .center([42.69, 25.42])
                .zoom(7)
                .popupMod('ctrlCmd')
                .filterByArea(true)
                .icon(function(d) {
                    var iconUrl;
                    switch (d.value.type) {
                        case 'solar':
                            iconUrl = 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png';
                            break;
                        case 'hydro':
                            iconUrl = 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png';
                            break;
                        case 'wind':
                            iconUrl = 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png';
                            break;
                        case 'biomass':
                            iconUrl = 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png';
                            break;
                        case 'gas_waste':
                            iconUrl = 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png';
                            break;
                        case 'hydro_waste':
                            iconUrl = 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png';
                            break;
                        default:
                            console.log('unk', d.value.type);
                            return new L.Icon.Default();
                    }
                    return new L.Icon({
                        iconUrl: iconUrl,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png'
                    });
                });

            var types = xf.dimension(function(d) {
                return d.type;
            });
            var typesGroup = types.group().reduceCount();

            var pie = dc.pieChart("#demo2 .pie", groupname)
                .dimension(types)
                .group(typesGroup)
                .width(200)
                .height(200)
                .renderLabel(true)
                .renderTitle(true)
                .ordering(function(p) {
                    return -p.value;
                });

            dc.renderAll(groupname);
            return {
                marker: marker,
                pie: pie
            };
        }

        Promise.all([d3.json("bulgaria.geojson"), d3.csv("demo2.csv")])
            .then(function([demo2_geojson, demo2]) {
                drawChoropleth(demo2, demo2_geojson);
                returnObject = drawBubbles(demo2, demo2_geojson);
            });

        /*     Choropleth      */

        function drawChoropleth(data, geojson) {
            dataP = [];

            data.filter(function(d) {
                return d.code && d.code != 'SOF46';
            }).forEach(function(d) {
                d.sum = 0;
                for (var p in d)
                    if (p && p != "code" && p != "sum") {
                        dataP.push({
                            'code': d.code,
                            'type': p,
                            'value': +d[p]
                        });
                        d.sum += +d[p];
                    }
            });
            delete data;

            var xf = crossfilter(dataP);
            var groupname = "Choropleth";
            var facilities = xf.dimension(function(d) {
                return d.code;
            });
            var facilitiesGroup = facilities.group().reduceSum(function(d) {
                return d.value;
            });

            var choro = dc_leaflet.choroplethChart("#demo3 .map", groupname)
                .dimension(facilities)
                .group(facilitiesGroup)
                .width(600)
                .height(400)
                .center([42.69, 25.42])
                .zoom(7)
                .geojson(geojson)
                .colors(colorbrewer.YlGnBu[7])
                .colorDomain([
                    d3.min(facilitiesGroup.all(), dc.pluck('value')),
                    d3.max(facilitiesGroup.all(), dc.pluck('value'))
                ])
                .colorAccessor(function(d, i) {
                    return d.value;
                })
                .featureKeyAccessor(function(feature) {
                    return feature.properties.code;
                })
                .popupMod('ctrlCmd')
                .renderPopup(true)
                .popup(function(d, feature) {
                    return feature.properties.nameEn + " : " + d.value;
                })
                .legend(dc_leaflet.legend().position('bottomright'));


            var types = xf.dimension(function(d) {
                return d.type;
            });
            var typesGroup = types.group().reduceSum(function(d) {
                return d.value;
            });

            var pie = dc.pieChart("#demo3 .pie", groupname)
                .dimension(types)
                .group(typesGroup)
                .width(200)
                .height(200)
                .ordering(function(p) {
                    return +p.key.substr(6);
                })
                .renderLabel(false)
                .renderTitle(true)
                .title(function(d) {
                    var age = d.key.substr(6);
                    if (age.indexOf("p") == -1)
                        age = "Between " + (+age - 4) + "-" + age;
                    else
                        age = "Over " + age.substr(0, 2);
                    return age + " : " + d.value;
                });

            dc.renderAll(groupname);
            return {
                choro: choro,
                pie: pie
            };
        }
        /*     Bubble Chart      */

        function drawBubbles(data, geojson) {
            // extract centroids from geojson shapes
            dataP = [];
            var pos = {},
                max = 0;
            data.forEach(function(d) {
                var geo = geojson.features.find(f => f.properties.code === d.code);
                var points = geo.geometry.coordinates[0];
                if (Array.isArray(points[0][0]))
                    points = geo.geometry.coordinates.reduce(function(p, v) {
                        return p.concat(v);
                    }, []);
                var p = [d3.sum(points, p => +p[1]) / points.length, d3.sum(points, p => +p[0]) / points.length];
                pos[d.code] = p;
                d.sum = 0;
                for (var p in d)
                    if (p && p != "code" && p != "sum") {
                        dataP.push({
                            'code': d.code,
                            'type': p,
                            'value': +d[p]
                        });
                        d.sum += +d[p];
                    }
                if (d.sum > max)
                    max = d.sum;
            });
            delete data;

            var xf = crossfilter(dataP);
            var groupname = "Bubbles";
            var facilities = xf.dimension(function(d) {
                return d.code;
            });
            facilitiesGroup = facilities.group().reduceSum(function(d) {
                return d.value;
            });

            var choro = dc_leaflet.bubbleChart("#demo4 .map", groupname)
                .dimension(facilities)
                .group(facilitiesGroup)
                .width(600)
                .height(400)
                .center([42.69, 25.42])
                .renderPopup(false)
                .colors(colorbrewer.Reds[7])
                .colorDomain([
                    d3.min(facilitiesGroup.all(), dc.pluck('value')),
                    d3.mean(facilitiesGroup.all(), dc.pluck('value'))
                ])
                .colorAccessor(function(d, i) {
                    return d.value;
                })
                .popup(d => d.key)
                .zoom(7)
                .locationAccessor(d => pos[d.key])
                .r(d3.scaleLog().domain([1, max]).range([0, 20]))
                .legend(dc_leaflet.legend().position('bottomright').legendTitle("Bubble"));

            var types = xf.dimension(function(d) {
                return d.type;
            });
            var typesGroup = types.group().reduceSum(function(d) {
                return d.value;
            });

            var pie = dc.pieChart("#demo4 .pie", groupname)
                .dimension(types)
                .group(typesGroup)
                .width(200)
                .height(200)
                .ordering(function(p) {
                    return +p.key.substr(6);
                })
                .renderLabel(false)
                .renderTitle(true)
                .title(function(d) {
                    var age = d.key.substr(6);
                    if (age.indexOf("p") == -1)
                        age = "Between " + (+age - 4) + "-" + age;
                    else
                        age = "Over " + age.substr(0, 2);
                    return age + " : " + d.value;
                });

            dc.renderAll(groupname);
            return {
                choro: choro,
                pie: pie
            };
        }
    </script>

    </script>


    <!-- <script>
        jQuery('#loadingGIF').fadeOut(3 * 1000);
    </script> -->



</body>

</html>